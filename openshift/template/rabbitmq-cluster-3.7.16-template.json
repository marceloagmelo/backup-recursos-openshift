{"kind":"Template","apiVersion":"template.openshift.io/v1","metadata":{"name":"rabbitmq-cluster-3.7.16-template","namespace":"openshift","selfLink":"/apis/template.openshift.io/v1/namespaces/openshift/templates/rabbitmq-cluster-3.7.16-template","uid":"c4119c02-aa48-11e9-984c-42010a9e0002","resourceVersion":"131030","creationTimestamp":"2019-07-19T17:15:11Z","annotations":{"description":"Template para deploy Rabbitmq Cluster (BR)","iconClass":"icon-rabbitmq","kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"template.openshift.io/v1\",\"kind\":\"Template\",\"labels\":{\"template\":\"rabbitmq-cluster-3.7.16-template\"},\"metadata\":{\"annotations\":{\"description\":\"Template para deploy Rabbitmq Cluster (BR)\",\"iconClass\":\"icon-rabbitmq\",\"openshift.io/display-name\":\"Rabbitmq Cluster 3.7.16 (BR)\",\"openshift.io/documentation-url\":\"https://gitlab.produbanbr.corp/paas-brasil/openshift-templates\",\"openshift.io/provider-display-name\":\"Santander Tecnologia - PaaS Brasil.\",\"tags\":\"runtime,instant-app,rabbitmq,cluster\"},\"name\":\"rabbitmq-cluster-3.7.16-template\",\"namespace\":\"openshift\"},\"objects\":[{\"apiVersion\":\"v1\",\"kind\":\"ServiceAccount\",\"metadata\":{\"name\":\"${SERVICE_ACCOUNT}\"}},{\"apiVersion\":\"v1\",\"kind\":\"RoleBinding\",\"metadata\":{\"name\":\"${SERVICE_ACCOUNT}-view\"},\"roleRef\":{\"kind\":\"Role\",\"name\":\"view\"},\"subjects\":[{\"kind\":\"ServiceAccount\",\"name\":\"${SERVICE_ACCOUNT}\"}]},{\"apiVersion\":\"v1\",\"kind\":\"PersistentVolumeClaim\",\"metadata\":{\"name\":\"${APP_NAME}-storage\"},\"spec\":{\"accessModes\":[\"ReadWriteMany\"],\"resources\":{\"requests\":{\"storage\":\"${VOLUME_SIZE}\"}}}},{\"apiVersion\":\"v1\",\"kind\":\"Secret\",\"metadata\":{\"name\":\"${APP_NAME}-secret\"},\"stringData\":{\"cookie\":\"${RABBITMQ_ERLANG_COOKIE}\",\"password\":\"${RABBITMQ_DEFAULT_PASS}\",\"url\":\"amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${APP_NAME}-balancer\",\"username\":\"${RABBITMQ_DEFAULT_USER}\"},\"type\":\"Opaque\"},{\"apiVersion\":\"v1\",\"data\":{\"enabled_plugins\":\"[rabbitmq_management,rabbitmq_peer_discovery_k8s].\\n\",\"rabbitmq.conf\":\"loopback_users.guest = false\\n\\n## Clustering\\ncluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s\\ncluster_formation.k8s.host = kubernetes.default.svc.cluster.local\\ncluster_formation.k8s.address_type = hostname\\ncluster_formation.k8s.hostname_suffix = .${APP_NAME}.${NAMESPACE}.svc.cluster.local\\ncluster_formation.node_cleanup.interval = 10\\ncluster_formation.node_cleanup.only_log_warning = true\\ncluster_partition_handling = autoheal\\n## queue master locator\\nqueue_master_locator=min-masters\\n\"},\"kind\":\"ConfigMap\",\"metadata\":{\"name\":\"${APP_NAME}-config\"}},{\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"labels\":{\"app\":\"${APP_NAME}\",\"app_name\":\"${APP_NAME}\",\"type\":\"LoadBalancer\"},\"name\":\"${APP_NAME}-balancer\"},\"spec\":{\"ports\":[{\"name\":\"http\",\"port\":15672,\"protocol\":\"TCP\",\"targetPort\":15672},{\"name\":\"amqp\",\"port\":5672,\"protocol\":\"TCP\",\"targetPort\":5672}],\"selector\":{\"app\":\"${APP_NAME}\"},\"type\":\"ClusterIP\"}},{\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"labels\":{\"app\":\"${APP_NAME}\",\"app_name\":\"${APP_NAME}\"},\"name\":\"${APP_NAME}\"},\"spec\":{\"clusterIP\":\"None\",\"ports\":[{\"name\":\"amqp\",\"port\":5672,\"targetPort\":5672}],\"selector\":{\"app\":\"${APP_NAME}\"}}},{\"apiVersion\":\"v1\",\"kind\":\"Route\",\"metadata\":{\"annotations\":{\"haproxy.router.openshift.io/balance\":\"roundrobin\"},\"labels\":{\"app\":\"${APP_NAME}\",\"app_name\":\"${APP_NAME}\"},\"name\":\"vs-${APP_NAME}\"},\"spec\":{\"host\":\"${HOSTNAME_APP}\",\"path\":\"${PATH_APP}\",\"port\":{\"targetPort\":\"http\"},\"tls\":{\"termination\":\"edge\"},\"to\":{\"kind\":\"Service\",\"name\":\"${APP_NAME}-balancer\"}},\"status\":{}},{\"apiVersion\":\"apps/v1beta1\",\"kind\":\"StatefulSet\",\"metadata\":{\"labels\":{\"app\":\"${APP_NAME}\",\"app_name\":\"${APP_NAME}\"},\"name\":\"${APP_NAME}\"},\"spec\":{\"replicas\":2,\"selector\":{\"matchLabels\":{\"app\":\"${APP_NAME}\"}},\"serviceName\":\"${APP_NAME}\",\"template\":{\"metadata\":{\"labels\":{\"app\":\"${APP_NAME}\",\"app_name\":\"${APP_NAME}\"}},\"spec\":{\"containers\":[{\"args\":[\"-c\",\"cp -v /etc/rabbitmq/rabbitmq.conf ${RABBITMQ_CONFIG_FILE}.conf; exec docker-entrypoint.sh rabbitmq-server\"],\"command\":[\"sh\"],\"env\":[{\"name\":\"RABBITMQ_DEFAULT_USER\",\"valueFrom\":{\"secretKeyRef\":{\"key\":\"username\",\"name\":\"${APP_NAME}-secret\"}}},{\"name\":\"RABBITMQ_DEFAULT_PASS\",\"valueFrom\":{\"secretKeyRef\":{\"key\":\"password\",\"name\":\"${APP_NAME}-secret\"}}},{\"name\":\"RABBITMQ_RABBITMQ_ERLANG_COOKIE\",\"valueFrom\":{\"secretKeyRef\":{\"key\":\"cookie\",\"name\":\"${APP_NAME}-secret\"}}},{\"name\":\"K8S_SERVICE_NAME\",\"value\":\"${APP_NAME}\"},{\"name\":\"PROJECT_NAME\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"metadata.namespace\"}}},{\"name\":\"TZ\",\"value\":\"${TZ}\"},{\"name\":\"http_proxy\",\"value\":\"${http_proxy}\"},{\"name\":\"https_proxy\",\"value\":\"${https_proxy}\"},{\"name\":\"no_proxy\",\"value\":\"*.corp\"},{\"name\":\"POD_IP\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"status.podIP\"}}},{\"name\":\"POD_NAME\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"metadata.name\"}}},{\"name\":\"POD_NAMESPACE\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"metadata.namespace\"}}},{\"name\":\"RABBITMQ_USE_LONGNAME\",\"value\":\"true\"},{\"name\":\"RABBITMQ_NODENAME\",\"value\":\"rabbit@$(POD_NAME).${APP_NAME}.$(POD_NAMESPACE).svc.cluster.local\"},{\"name\":\"RABBITMQ_CONFIG_FILE\",\"value\":\"/var/lib/rabbitmq/rabbitmq\"}],\"image\":\"${IMAGE_NAME}:${IMAGE_VERSION}\",\"imagePullPolicy\":\"IfNotPresent\",\"livenessProbe\":{\"exec\":{\"command\":[\"rabbitmqctl\",\"status\"]},\"initialDelaySeconds\":30,\"timeoutSeconds\":10},\"name\":\"rabbitmq\",\"ports\":[{\"containerPort\":15672,\"name\":\"http\",\"protocol\":\"TCP\"},{\"containerPort\":5672,\"name\":\"amqp\",\"protocol\":\"TCP\"}],\"readinessProbe\":{\"exec\":{\"command\":[\"rabbitmqctl\",\"status\"]},\"initialDelaySeconds\":10,\"timeoutSeconds\":10},\"volumeMounts\":[{\"mountPath\":\"/etc/rabbitmq\",\"name\":\"config-volume\"},{\"mountPath\":\"/var/lib/rabbitmq\",\"name\":\"${APP_NAME}-storage\"}]}],\"serviceAccountName\":\"${SERVICE_ACCOUNT}\",\"terminationGracePeriodSeconds\":30,\"volumes\":[{\"configMap\":{\"items\":[{\"key\":\"rabbitmq.conf\",\"path\":\"rabbitmq.conf\"},{\"key\":\"enabled_plugins\",\"path\":\"enabled_plugins\"}],\"name\":\"${APP_NAME}-config\"},\"name\":\"config-volume\"},{\"name\":\"${APP_NAME}-storage\",\"persistentVolumeClaim\":{\"claimName\":\"${APP_NAME}-storage\"}}]}}}}],\"parameters\":[{\"description\":\"OpenShift project (current namespace)\",\"name\":\"NAMESPACE\",\"required\":true},{\"description\":\"Name of the RabbitMQ cluster\",\"name\":\"APP_NAME\",\"value\":\"rabbitmq-cluster\"},{\"description\":\"Hostname APP\",\"displayName\":\"Hostname APP\",\"name\":\"HOSTNAME_APP\"},{\"description\":\"Path APP\",\"displayName\":\"Path APP\",\"name\":\"PATH_APP\",\"value\":\"/\"},{\"displayName\":\"http_proxy\",\"name\":\"http_proxy\"},{\"displayName\":\"https_proxy\",\"name\":\"https_proxy\"},{\"description\":\"TimeZone for the running containers.\",\"displayName\":\"TimeZone\",\"name\":\"TZ\",\"value\":\"America/Sao_Paulo\"},{\"description\":\"Image name\",\"displayName\":\"Image Name\",\"name\":\"IMAGE_NAME\",\"required\":true,\"value\":\"marceloagmelo/rabbitmq-cluster-3.7.16\"},{\"description\":\"Image version\",\"displayName\":\"Image version\",\"name\":\"IMAGE_VERSION\",\"required\":true,\"value\":\"1.0.0.RELEASE\"},{\"description\":\"Default usert\",\"displayName\":\"Default user\",\"name\":\"RABBITMQ_DEFAULT_USER\",\"value\":\"rabbitmq\"},{\"description\":\"Default password\",\"displayName\":\"Default password\",\"from\":\"[a-zA-Z0-9]{16}\",\"generate\":\"expression\",\"name\":\"RABBITMQ_DEFAULT_PASS\"},{\"description\":\"Cookie\",\"displayName\":\"Cookie\",\"from\":\"[a-zA-Z0-9]{16}\",\"generate\":\"expression\",\"name\":\"RABBITMQ_RABBITMQ_ERLANG_COOKIE\"},{\"description\":\"Name of the service account used by RabbitMQ k8s plugin\",\"name\":\"SERVICE_ACCOUNT\",\"value\":\"rabbitmq-discovery\"},{\"description\":\"Size of the RabbitMQ data volume\",\"name\":\"VOLUME_SIZE\",\"value\":\"1Gi\"}]}\n","openshift.io/display-name":"Rabbitmq Cluster 3.7.16 (BR)","openshift.io/documentation-url":"https://gitlab.produbanbr.corp/paas-brasil/openshift-templates","openshift.io/provider-display-name":"Santander Tecnologia - PaaS Brasil.","tags":"runtime,instant-app,rabbitmq,cluster"}},"objects":[{"apiVersion":"v1","kind":"ServiceAccount","metadata":{"name":"${SERVICE_ACCOUNT}"}},{"apiVersion":"v1","kind":"RoleBinding","metadata":{"name":"${SERVICE_ACCOUNT}-view"},"roleRef":{"kind":"Role","name":"view"},"subjects":[{"kind":"ServiceAccount","name":"${SERVICE_ACCOUNT}"}]},{"apiVersion":"v1","kind":"PersistentVolumeClaim","metadata":{"name":"${APP_NAME}-storage"},"spec":{"accessModes":["ReadWriteMany"],"resources":{"requests":{"storage":"${VOLUME_SIZE}"}}}},{"apiVersion":"v1","kind":"Secret","metadata":{"name":"${APP_NAME}-secret"},"stringData":{"cookie":"${RABBITMQ_ERLANG_COOKIE}","password":"${RABBITMQ_DEFAULT_PASS}","url":"amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${APP_NAME}-balancer","username":"${RABBITMQ_DEFAULT_USER}"},"type":"Opaque"},{"apiVersion":"v1","data":{"enabled_plugins":"[rabbitmq_management,rabbitmq_peer_discovery_k8s].\n","rabbitmq.conf":"loopback_users.guest = false\n\n## Clustering\ncluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s\ncluster_formation.k8s.host = kubernetes.default.svc.cluster.local\ncluster_formation.k8s.address_type = hostname\ncluster_formation.k8s.hostname_suffix = .${APP_NAME}.${NAMESPACE}.svc.cluster.local\ncluster_formation.node_cleanup.interval = 10\ncluster_formation.node_cleanup.only_log_warning = true\ncluster_partition_handling = autoheal\n## queue master locator\nqueue_master_locator=min-masters\n"},"kind":"ConfigMap","metadata":{"name":"${APP_NAME}-config"}},{"apiVersion":"v1","kind":"Service","metadata":{"labels":{"app":"${APP_NAME}","app_name":"${APP_NAME}","type":"LoadBalancer"},"name":"${APP_NAME}-balancer"},"spec":{"ports":[{"name":"http","port":15672,"protocol":"TCP","targetPort":15672},{"name":"amqp","port":5672,"protocol":"TCP","targetPort":5672}],"selector":{"app":"${APP_NAME}"},"type":"ClusterIP"}},{"apiVersion":"v1","kind":"Service","metadata":{"labels":{"app":"${APP_NAME}","app_name":"${APP_NAME}"},"name":"${APP_NAME}"},"spec":{"clusterIP":"None","ports":[{"name":"amqp","port":5672,"targetPort":5672}],"selector":{"app":"${APP_NAME}"}}},{"apiVersion":"v1","kind":"Route","metadata":{"annotations":{"haproxy.router.openshift.io/balance":"roundrobin"},"labels":{"app":"${APP_NAME}","app_name":"${APP_NAME}"},"name":"vs-${APP_NAME}"},"spec":{"host":"${HOSTNAME_APP}","path":"${PATH_APP}","port":{"targetPort":"http"},"tls":{"termination":"edge"},"to":{"kind":"Service","name":"${APP_NAME}-balancer"}},"status":{}},{"apiVersion":"apps/v1beta1","kind":"StatefulSet","metadata":{"labels":{"app":"${APP_NAME}","app_name":"${APP_NAME}"},"name":"${APP_NAME}"},"spec":{"replicas":2,"selector":{"matchLabels":{"app":"${APP_NAME}"}},"serviceName":"${APP_NAME}","template":{"metadata":{"labels":{"app":"${APP_NAME}","app_name":"${APP_NAME}"}},"spec":{"containers":[{"args":["-c","cp -v /etc/rabbitmq/rabbitmq.conf ${RABBITMQ_CONFIG_FILE}.conf; exec docker-entrypoint.sh rabbitmq-server"],"command":["sh"],"env":[{"name":"RABBITMQ_DEFAULT_USER","valueFrom":{"secretKeyRef":{"key":"username","name":"${APP_NAME}-secret"}}},{"name":"RABBITMQ_DEFAULT_PASS","valueFrom":{"secretKeyRef":{"key":"password","name":"${APP_NAME}-secret"}}},{"name":"RABBITMQ_RABBITMQ_ERLANG_COOKIE","valueFrom":{"secretKeyRef":{"key":"cookie","name":"${APP_NAME}-secret"}}},{"name":"K8S_SERVICE_NAME","value":"${APP_NAME}"},{"name":"PROJECT_NAME","valueFrom":{"fieldRef":{"fieldPath":"metadata.namespace"}}},{"name":"TZ","value":"${TZ}"},{"name":"http_proxy","value":"${http_proxy}"},{"name":"https_proxy","value":"${https_proxy}"},{"name":"no_proxy","value":"*.corp"},{"name":"POD_IP","valueFrom":{"fieldRef":{"fieldPath":"status.podIP"}}},{"name":"POD_NAME","valueFrom":{"fieldRef":{"fieldPath":"metadata.name"}}},{"name":"POD_NAMESPACE","valueFrom":{"fieldRef":{"fieldPath":"metadata.namespace"}}},{"name":"RABBITMQ_USE_LONGNAME","value":"true"},{"name":"RABBITMQ_NODENAME","value":"rabbit@$(POD_NAME).${APP_NAME}.$(POD_NAMESPACE).svc.cluster.local"},{"name":"RABBITMQ_CONFIG_FILE","value":"/var/lib/rabbitmq/rabbitmq"}],"image":"${IMAGE_NAME}:${IMAGE_VERSION}","imagePullPolicy":"IfNotPresent","livenessProbe":{"exec":{"command":["rabbitmqctl","status"]},"initialDelaySeconds":30,"timeoutSeconds":10},"name":"rabbitmq","ports":[{"containerPort":15672,"name":"http","protocol":"TCP"},{"containerPort":5672,"name":"amqp","protocol":"TCP"}],"readinessProbe":{"exec":{"command":["rabbitmqctl","status"]},"initialDelaySeconds":10,"timeoutSeconds":10},"volumeMounts":[{"mountPath":"/etc/rabbitmq","name":"config-volume"},{"mountPath":"/var/lib/rabbitmq","name":"${APP_NAME}-storage"}]}],"serviceAccountName":"${SERVICE_ACCOUNT}","terminationGracePeriodSeconds":30,"volumes":[{"configMap":{"items":[{"key":"rabbitmq.conf","path":"rabbitmq.conf"},{"key":"enabled_plugins","path":"enabled_plugins"}],"name":"${APP_NAME}-config"},"name":"config-volume"},{"name":"${APP_NAME}-storage","persistentVolumeClaim":{"claimName":"${APP_NAME}-storage"}}]}}}}],"parameters":[{"name":"NAMESPACE","description":"OpenShift project (current namespace)","required":true},{"name":"APP_NAME","description":"Name of the RabbitMQ cluster","value":"rabbitmq-cluster"},{"name":"HOSTNAME_APP","displayName":"Hostname APP","description":"Hostname APP"},{"name":"PATH_APP","displayName":"Path APP","description":"Path APP","value":"/"},{"name":"http_proxy","displayName":"http_proxy"},{"name":"https_proxy","displayName":"https_proxy"},{"name":"TZ","displayName":"TimeZone","description":"TimeZone for the running containers.","value":"America/Sao_Paulo"},{"name":"IMAGE_NAME","displayName":"Image Name","description":"Image name","value":"marceloagmelo/rabbitmq-cluster-3.7.16","required":true},{"name":"IMAGE_VERSION","displayName":"Image version","description":"Image version","value":"1.0.0.RELEASE","required":true},{"name":"RABBITMQ_DEFAULT_USER","displayName":"Default user","description":"Default usert","value":"rabbitmq"},{"name":"RABBITMQ_DEFAULT_PASS","displayName":"Default password","description":"Default password","generate":"expression","from":"[a-zA-Z0-9]{16}"},{"name":"RABBITMQ_RABBITMQ_ERLANG_COOKIE","displayName":"Cookie","description":"Cookie","generate":"expression","from":"[a-zA-Z0-9]{16}"},{"name":"SERVICE_ACCOUNT","description":"Name of the service account used by RabbitMQ k8s plugin","value":"rabbitmq-discovery"},{"name":"VOLUME_SIZE","description":"Size of the RabbitMQ data volume","value":"1Gi"}],"labels":{"template":"rabbitmq-cluster-3.7.16-template"}}
